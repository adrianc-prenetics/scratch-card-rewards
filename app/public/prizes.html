<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Prizes</title>
    <link rel="stylesheet" href="/assets/index.css" />
  </head>
  <body class="min-h-dvh bg-slate-50 text-black" style="min-height:100dvh;background:radial-gradient(1000px 520px at 20% -10%, rgba(164,0,17,0.12), transparent 60%),radial-gradient(900px 500px at 85% -5%, rgba(80,0,11,0.10), transparent 55%),linear-gradient(180deg, #fff 0%, #F5EAEA 55%, #FFE9D8 100%);background-attachment:fixed;">
    <div id="app" class="max-w-2xl mx-auto p-6" style="min-height:100dvh;display:flex;flex-direction:column;">
      <h1 class="headline text-brand-dark">Prize Settings</h1>
      <p class="subhead mt-2">Update totals and remaining. Use -1 to mark a prize as unlimited.</p>
      <form id="prizeForm" class="mt-6 space-y-4"></form>
      <div class="mt-6 flex items-center gap-3">
        <button id="saveBtn" class="btn-primary">Save</button>
        <button id="seedBtn" class="btn-primary" style="background:#6b7280">Seed defaults</button>
        <button id="createBtn" class="btn-primary" style="background:#374151">Create new sheet + seed</button>
      </div>
      <pre id="status" class="mt-4 text-xs text-brand-dark" style="flex:1 0 auto"></pre>
    </div>
    <script type="module">
      function getAdminKey() {
        try { return sessionStorage.getItem('adminKey') || '' } catch { return '' }
      }

      function setAdminKey(k) {
        try { sessionStorage.setItem('adminKey', k || '') } catch {}
      }

      async function fetchWithAdmin(url, opts = {}) {
        const headers = new Headers(opts.headers || {})
        const key = getAdminKey()
        if (key) headers.set('x-admin-key', key)
        const res = await fetch(url, { ...opts, headers })
        if (res.status === 401) {
          const input = window.prompt('Enter admin key:')
          if (!input) return res
          setAdminKey(input)
          headers.set('x-admin-key', input)
          return fetch(url, { ...opts, headers })
        }
        return res
      }

      async function load() {
        const res = await fetch('/api/prizes')
        const data = await res.json()
        const form = document.getElementById('prizeForm')
        form.innerHTML = ''
        data.prizes.forEach(p => {
          const row = document.createElement('div')
          row.className = 'glass rounded-xl p-4'
          row.innerHTML = `
            <div class="font-semibold mb-2">${p.name} (${p.id})${p.baseline ? ' â€” baseline' : ''}</div>
            <div class="grid grid-cols-2 gap-4">
              <label class="text-sm">
                <div>Total</div>
                <input type="number" class="input" name="total-${p.id}" value="${p.total === -1 ? '' : p.total}" placeholder="Unlimited (-1)" />
              </label>
              <label class="text-sm">
                <div>Remaining</div>
                <input type="number" class="input" name="remaining-${p.id}" value="${p.remaining === -1 ? '' : p.remaining}" placeholder="Unlimited (-1)" />
              </label>
            </div>
          `
          form.appendChild(row)
        })
      }

      document.getElementById('saveBtn').addEventListener('click', async (e) => {
        e.preventDefault()
        const res = await fetch('/api/prizes')
        const data = await res.json()
        const payload = { prizes: [] }
        data.prizes.forEach(p => {
          const total = document.querySelector(`[name=total-${p.id}]`)
          const remaining = document.querySelector(`[name=remaining-${p.id}]`)
          const entry = { id: p.id }
          if (total) {
            const v = (total.value ?? '').trim()
            entry.total = v === '' ? -1 : parseInt(v, 10)
          }
          if (remaining) {
            const v = (remaining.value ?? '').trim()
            entry.remaining = v === '' ? -1 : parseInt(v, 10)
          }
          // If baseline and remaining left blank but total provided as finite, set remaining = total
          if (p.baseline) {
            const finiteTotal = (typeof entry.total === 'number' && entry.total >= 0)
            const remainingUnset = (typeof entry.remaining !== 'number') || isNaN(entry.remaining)
            if (finiteTotal && remainingUnset) {
              entry.remaining = entry.total
            }
          }
          payload.prizes.push(entry)
        })
        const r = await fetch('/api/prizes', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
        const updated = await r.json()
        document.getElementById('status').textContent = JSON.stringify(updated, null, 2)
        load()
      })

      document.getElementById('seedBtn').addEventListener('click', async (e) => {
        e.preventDefault()
        const r = await fetchWithAdmin('/api/sheet/seed', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) })
        const resp = await r.json().catch(() => ({}))
        document.getElementById('status').textContent = JSON.stringify(resp, null, 2)
        load()
      })

      document.getElementById('createBtn').addEventListener('click', async (e) => {
        e.preventDefault()
        const title = prompt('Spreadsheet title:', 'Scratch Rewards') || 'Scratch Rewards'
        const r = await fetchWithAdmin('/api/sheet/seed', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ createNew: true, title }) })
        const resp = await r.json().catch(() => ({}))
        const s = document.getElementById('status')
        s.textContent = JSON.stringify(resp, null, 2)
        if (resp && resp.url) {
          const a = document.createElement('a')
          a.href = resp.url
          a.target = '_blank'
          a.rel = 'noreferrer'
          a.textContent = 'Open spreadsheet'
          s.appendChild(document.createElement('div')).appendChild(a)
        }
        load()
      })

      load()
    </script>
  </body>
  </html>


